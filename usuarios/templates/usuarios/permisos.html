{% extends 'common/base.html' %}

{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'usuarios/usuarios_mejorado.css' %}">

<script src="{% static 'usuarios/modals.js' %}"></script>
<script src="{% static 'usuarios/permiso_modals.js' %}"></script>

{% include 'usuarios/modal_permiso.html' %}
{% include 'usuarios/modal_base.html' %}

<div class="usuarios-container">
  <!-- Header mejorado -->
  <div class="header-usuarios">
    <h2>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="header-icon">
        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
        <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.58L18 9l-8 8z" fill="white"/>
      </svg>
      Gestión de Permisos
    </h2>
    <button class="btn-agregar-usuario" onclick="openPermisoModal('Nuevo Permiso', '', '{% url 'permiso_create' %}')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Nuevo Permiso
    </button>
  </div>

  <!-- Estadísticas rápidas -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>{{ permisos|length }}</h3>
        <p>Total Permisos</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon stat-icon-active">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" fill="currentColor"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>{{ permisos|length }}</h3>
        <p>Permisos Activos</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-modules">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" fill="currentColor"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3>5</h3>
        <p>Módulos</p>
      </div>
    </div>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="filtros-usuarios">
    <div class="filtro-grupo">
      <label>Buscar Permiso</label>
      <input type="text" class="filtro-input" placeholder="Buscar por nombre..." id="search-permisos">
    </div>
    
    <div class="filtro-grupo">
      <label>Módulo</label>
      <select class="filtro-input" id="filter-module">
        <option value="">Todos los módulos</option>
        <option value="usuarios">Usuarios</option>
        <option value="clientes">Clientes</option>
        <option value="membresias">Membresías</option>
        <option value="reportes">Reportes</option>
        <option value="configuracion">Configuración</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <button class="btn-filtro-limpiar" onclick="limpiarFiltros()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
        </svg>
        Limpiar
      </button>
    </div>
  </div>

  <!-- Contenedor de tabla mejorado -->
  <div class="table-container">
    <table class="table-usuarios">
      <thead>
        <tr>
          <th class="col-icono">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
            </svg>
          </th>
          <th class="col-nombre">Nombre del Permiso</th>
          <th class="col-descripcion">Descripción</th>
          <th class="col-modulo">Módulo</th>
          <th class="col-acciones">Acciones</th>
        </tr>
      </thead>
      <tbody id="permisos-tbody">
        {% for permiso in permisos %}
        <tr class="permiso-row" data-nombre="{{ permiso.nombre|lower }}" data-modulo="{{ permiso.modulo|default:'general'|lower }}">
          <td class="col-icono">
            <div class="permiso-icon">
              {% if 'crear' in permiso.nombre|lower %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              {% elif 'editar' in permiso.nombre|lower %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
              {% elif 'eliminar' in permiso.nombre|lower %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
              {% elif 'ver' in permiso.nombre|lower %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" fill="none" stroke="currentColor" stroke-width="2"/>
                  <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
              {% else %}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
                </svg>
              {% endif %}
            </div>
          </td>
          <td class="col-nombre">
            <div class="permiso-nombre">
              <span class="nombre-principal">{{ permiso.nombre }}</span>
              <span class="codigo-permiso">{{ permiso.codigo|default:permiso.nombre|slugify }}</span>
            </div>
          </td>
          <td class="col-descripcion">
            <p class="descripcion-texto">{{ permiso.descripcion|default:"Sin descripción disponible" }}</p>
          </td>
          <td class="col-modulo">
            <span class="badge-modulo badge-modulo-{{ permiso.modulo|default:'general'|lower }}">
              {{ permiso.modulo|default:'General'|title }}
            </span>
          </td>
          <td class="col-acciones">
            <div class="acciones-usuario">
              <button class="accion-btn editar" 
                      onclick="openPermisoModal('Editar Permiso', '', '{% url 'permiso_update' permiso.id_permiso %}')"
                      title="Editar permiso">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" fill="none" stroke="currentColor" stroke-width="2"/>
                  <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
              <button class="accion-btn eliminar" 
                      onclick="openPermisoDeleteModal('¿Estás seguro de eliminar el permiso <strong>{{ permiso.nombre }}</strong>?', '{% url 'permiso_delete' permiso.id_permiso %}')"
                      title="Eliminar permiso">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr class="empty-row">
          <td colspan="5">
            <div class="tabla-vacia">
              <div class="tabla-vacia-icon">🔐</div>
              <h3>No hay permisos registrados</h3>
              <p>Comienza creando el primer permiso del sistema</p>
              <button class="btn-crear-primero" onclick="openPermisoModal('Nuevo Permiso', '', '{% url 'permiso_create' %}')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Crear Primer Permiso
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Información adicional -->
  <div class="info-section">
    <div class="info-card">
      <div class="info-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M12 16v-4M12 8h.01" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="info-content">
        <h4>¿Qué son los permisos?</h4>
        <p>Los permisos definen qué acciones pueden realizar los usuarios en cada módulo del sistema. Cada rol puede tener diferentes permisos asignados.</p>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== ESTILOS ESPECÍFICOS PARA PERMISOS ===== */

/* Header icon */
.header-icon {
  color: #0066ff;
  margin-right: 8px;
}

/* Stats container */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.stat-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.3s ease;
  border: 1px solid #e2e8f0;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.stat-icon {
  background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
  color: white;
  border-radius: 12px;
  padding: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
}

.stat-icon-active {
  background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
}

.stat-icon-modules {
  background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
  box-shadow: 0 4px 12px rgba(128, 90, 213, 0.3);
}

.stat-content h3 {
  font-size: 28px;
  font-weight: 700;
  color: #2d3748;
  margin: 0 0 4px 0;
}

.stat-content p {
  font-size: 14px;
  color: #6b7280;
  margin: 0;
  font-weight: 500;
}

/* Botón limpiar filtros */
.btn-filtro-limpiar {
  background: #f7fafc;
  color: #6b7280;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 20px;
}

.btn-filtro-limpiar:hover {
  background: #edf2f7;
  border-color: #cbd5e0;
  color: #4a5568;
}

/* Columnas específicas */
.col-icono {
  width: 60px;
  text-align: center;
}

.col-nombre {
  width: 25%;
}

.col-descripcion {
  width: 35%;
}

.col-modulo {
  width: 15%;
  text-align: center;
}

.col-acciones {
  width: 120px;
  text-align: center;
}

/* Icono de permiso */
.permiso-icon {
  background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
  color: #0066ff;
  border-radius: 8px;
  padding: 8px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(0, 102, 255, 0.2);
}

/* Nombre del permiso */
.permiso-nombre {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.nombre-principal {
  font-weight: 600;
  color: #2d3748;
  font-size: 15px;
}

.codigo-permiso {
  font-size: 12px;
  color: #6b7280;
  font-family: 'Courier New', monospace;
  background: #f7fafc;
  padding: 2px 6px;
  border-radius: 4px;
  display: inline-block;
}

/* Descripción */
.descripcion-texto {
  color: #4a5568;
  line-height: 1.4;
  margin: 0;
  font-size: 14px;
}

/* Badges de módulo */
.badge-modulo {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.badge-modulo-usuarios {
  background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
  color: white;
}

.badge-modulo-clientes {
  background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  color: white;
}

.badge-modulo-membresias {
  background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
  color: white;
}

.badge-modulo-reportes {
  background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
  color: white;
}

.badge-modulo-configuracion {
  background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  color: white;
}

.badge-modulo-general {
  background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
  color: white;
}

/* Botón crear primero */
.btn-crear-primero {
  background: linear-gradient(135deg, #0066ff 0%, #0052cc 100%);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
  box-shadow: 0 4px 15px rgba(0, 102, 255, 0.3);
}

.btn-crear-primero:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 102, 255, 0.4);
}

/* Sección de información */
.info-section {
  margin-top: 32px;
}

.info-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 1px solid #bae6fd;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.info-icon {
  background: #0284c7;
  color: white;
  border-radius: 8px;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.info-content h4 {
  font-size: 16px;
  font-weight: 600;
  color: #0c4a6e;
  margin: 0 0 8px 0;
}

.info-content p {
  color: #0369a1;
  margin: 0;
  line-height: 1.5;
  font-size: 14px;
}

/* Responsive */
@media (max-width: 768px) {
  .stats-container {
    grid-template-columns: 1fr;
  }
  
  .info-card {
    flex-direction: column;
    text-align: center;
  }
  
  .permiso-nombre {
    align-items: flex-start;
  }
  
  .codigo-permiso {
    align-self: flex-start;
  }
}

/* Animaciones para filas */
.permiso-row {
  animation: fadeInUp 0.3s ease-out;
}

.permiso-row:nth-child(1) { animation-delay: 0.1s; }
.permiso-row:nth-child(2) { animation-delay: 0.2s; }
.permiso-row:nth-child(3) { animation-delay: 0.3s; }
.permiso-row:nth-child(4) { animation-delay: 0.4s; }
.permiso-row:nth-child(5) { animation-delay: 0.5s; }
</style>

<script>
// JavaScript para funcionalidades de permisos
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-permisos');
  const moduleFilter = document.getElementById('filter-module');
  const tbody = document.getElementById('permisos-tbody');
  
  // Función de búsqueda
  function filtrarPermisos() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedModule = moduleFilter.value.toLowerCase();
    const rows = tbody.querySelectorAll('.permiso-row');
    
    rows.forEach(row => {
      const nombre = row.dataset.nombre;
      const modulo = row.dataset.modulo;
      
      const matchesSearch = nombre.includes(searchTerm);
      const matchesModule = !selectedModule || modulo === selectedModule;
      
      if (matchesSearch && matchesModule) {
        row.style.display = '';
        row.style.animation = 'fadeInUp 0.3s ease-out';
      } else {
        row.style.display = 'none';
      }
    });
    
    // Mostrar mensaje si no hay resultados
    const visibleRows = tbody.querySelectorAll('.permiso-row[style=""], .permiso-row:not([style])');
    const emptyRow = tbody.querySelector('.empty-row');
    
    if (visibleRows.length === 0 && !emptyRow) {
      const noResultsRow = document.createElement('tr');
      noResultsRow.className = 'no-results-row';
      noResultsRow.innerHTML = `
        <td colspan="5">
          <div class="tabla-vacia">
            <div class="tabla-vacia-icon">🔍</div>
            <h3>No se encontraron permisos</h3>
            <p>Intenta con otros términos de búsqueda</p>
          </div>
        </td>
      `;
      tbody.appendChild(noResultsRow);
    } else if (visibleRows.length > 0) {
      const noResultsRow = tbody.querySelector('.no-results-row');
      if (noResultsRow) {
        noResultsRow.remove();
      }
    }
  }
  
  // Event listeners
  if (searchInput) {
    searchInput.addEventListener('input', filtrarPermisos);
  }
  
  if (moduleFilter) {
    moduleFilter.addEventListener('change', filtrarPermisos);
  }
});

// Función para limpiar filtros
function limpiarFiltros() {
  document.getElementById('search-permisos').value = '';
  document.getElementById('filter-module').value = '';
  
  // Mostrar todas las filas
  const rows = document.querySelectorAll('.permiso-row');
  rows.forEach(row => {
    row.style.display = '';
  });
  
  // Remover mensaje de no resultados
  const noResultsRow = document.querySelector('.no-results-row');
  if (noResultsRow) {
    noResultsRow.remove();
  }
}
</script>

{% endblock %}
